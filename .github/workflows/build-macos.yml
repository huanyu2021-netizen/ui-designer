name: Build macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build macOS app
        run: pnpm run tauri:build

      - name: Create distributable package
        run: |
          VERSION="1.0.0"
          DIST_DIR="ADP-UI-Designer-macOS-v${VERSION}"

          mkdir -p "$DIST_DIR"
          cp -R "src-tauri/target/release/bundle/macos/ADP UI Designer.app" "$DIST_DIR/"

          # 创建使用说明
          cat > "$DIST_DIR/使用说明.txt" << 'EOF'
          ADP UI Designer - macOS 版本
          ================================

          版本：1.0.0
          平台：macOS 10.15+

          使用方法：
          1. 双击 "ADP UI Designer.app" 启动应用
          2. 如果提示"无法打开"，请右键点击选择"打开"
          3. 首次运行需要初始化工作空间

          注意事项：
          - 资源文件已内置到应用中
          - 建议拖拽到"应用程序"文件夹使用
          EOF

          # 创建 DMG 镜像
          hdiutil create -volname "ADP UI Designer" -srcfolder "$DIST_DIR" -ov -format UDZO "ADP-UI-Designer-macOS-v${VERSION}.dmg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: |
            ADP-UI-Designer-macOS-v*.dmg
            ADP-UI-Designer-macOS-v*/

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ADP-UI-Designer-macOS-v*.dmg
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

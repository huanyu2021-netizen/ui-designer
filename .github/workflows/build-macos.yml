name: Build macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build macOS app
        run: pnpm run tauri:build

      - name: Fix Info.plist - Remove LSRequiresCarbon
        run: |
          APP_PATH="src-tauri/target/release/bundle/macos/ADP UI Designer.app"
          INFO_PLIST="$APP_PATH/Contents/Info.plist"

          if [ -f "$INFO_PLIST" ]; then
            echo "ðŸ”§ æ­£åœ¨ä¿®å¤ Info.plist..."

            # åˆ é™¤ LSRequiresCarbon é”®åŠå…¶å€¼
            /usr/libexec/PlistBuddy -c "Delete :LSRequiresCarbon" "$INFO_PLIST" 2>/dev/null || echo "LSRequiresCarbon ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"

            # éªŒè¯æ˜¯å¦åˆ é™¤æˆåŠŸ
            if /usr/libexec/PlistBuddy -c "Print :LSRequiresCarbon" "$INFO_PLIST" 2>/dev/null; then
              echo "âŒ è­¦å‘Š: LSRequirementsCarbon ä»ç„¶å­˜åœ¨"
              exit 1
            else
              echo "âœ… æˆåŠŸ: LSRequirementsCarbon å·²åˆ é™¤"
            fi

            # æ˜¾ç¤ºä¿®æ”¹åŽçš„å†…å®¹ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
            echo "ðŸ“„ Info.plist ç›¸å…³å†…å®¹ï¼š"
            grep -A 1 -B 1 "MinimumOSVersion\|LSRequiresCarbon" "$INFO_PLIST" || echo "æœªæ‰¾åˆ°ç›¸å…³é”®"
          else
            echo "âŒ é”™è¯¯: Info.plist ä¸å­˜åœ¨äºŽ $INFO_PLIST"
            exit 1
          fi

      - name: Create distributable package
        run: |
          VERSION="1.0.0"
          DIST_DIR="ADP-UI-Designer-macOS-v${VERSION}"

          mkdir -p "$DIST_DIR"
          cp -R "src-tauri/target/release/bundle/macos/ADP UI Designer.app" "$DIST_DIR/"

          # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
          cat > "$DIST_DIR/ä½¿ç”¨è¯´æ˜Ž.txt" << 'EOF'
          ADP UI Designer - macOS ç‰ˆæœ¬
          ================================

          ç‰ˆæœ¬ï¼š1.0.0
          å¹³å°ï¼šmacOS 10.15+

          ä½¿ç”¨æ–¹æ³•ï¼š
          1. åŒå‡» "ADP UI Designer.app" å¯åŠ¨åº”ç”¨
          2. å¦‚æžœæç¤º"æ— æ³•æ‰“å¼€"ï¼Œè¯·å³é”®ç‚¹å‡»é€‰æ‹©"æ‰“å¼€"
          3. é¦–æ¬¡è¿è¡Œéœ€è¦åˆå§‹åŒ–å·¥ä½œç©ºé—´

          æ³¨æ„äº‹é¡¹ï¼š
          - èµ„æºæ–‡ä»¶å·²å†…ç½®åˆ°åº”ç”¨ä¸­
          - å»ºè®®æ‹–æ‹½åˆ°"åº”ç”¨ç¨‹åº"æ–‡ä»¶å¤¹ä½¿ç”¨
          EOF

          # åˆ›å»º DMG é•œåƒ
          hdiutil create -volname "ADP UI Designer" -srcfolder "$DIST_DIR" -ov -format UDZO "ADP-UI-Designer-macOS-v${VERSION}.dmg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: |
            ADP-UI-Designer-macOS-v*.dmg
            ADP-UI-Designer-macOS-v*/

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ADP-UI-Designer-macOS-v*.dmg
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
